---
import { Image } from "astro:assets";

export interface Props {
    slug: string;
    title: string;
    description: string;
    cover?: any; // string o ImageMetadata
    category: string;
    tags?: string[];
    pdf?: string;
    eager?: boolean;
}

const {
    slug,
    title,
    description,
    cover,
    category,
    tags = [],
    pdf,
    eager = false,
} = Astro.props;

const site = (Astro.site ?? "https://imprimibleseduca.com")
    .toString()
    .replace(/\/$/, "");

function buildPdfUrl(p?: string) {
    if (!p) return null;
    const raw = p.startsWith("http") ? p : p.startsWith("/") ? p : `/${p}`;
    return encodeURI(new URL(raw, site).href);
}
const pdfUrl = buildPdfUrl(pdf);

// mismo dominio?
function isSameOrigin(url?: string | null) {
    try {
        if (!url) return false;
        return new URL(url).origin === new URL(site).origin;
    } catch {
        return false;
    }
}

const canUseAstroImage = cover && typeof cover === "object" && "src" in cover;

// atributos normalizados para filtrado
const dataTitle = String(title || "").toLowerCase();
const dataTags = (tags || []).map((t) => String(t).toLowerCase()).join(",");
---

<article
    class="group rounded-xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden"
    data-title={dataTitle}
    data-category={category}
    data-tags={dataTags}
>
    <a
        href={`/recursos/${slug}/`}
        data-astro-prefetch
        aria-label={`Ver ficha: ${title}`}
        class="block"
    >
        <div
            class="flex items-center justify-center bg-gray-50 rounded-t-xl min-h-[176px]"
        >
            {
                cover ? (
                    canUseAstroImage ? (
                        <Image
                            src={cover}
                            alt={title}
                            width={600}
                            height={400}
                            fit="contain"
                            loading={eager ? "eager" : "lazy"}
                            fetchpriority={eager ? "high" : "auto"}
                            sizes="(max-width:640px) 100vw, (max-width:1024px) 50vw, 33vw"
                            class="max-h-[176px] w-auto"
                        />
                    ) : (
                        <img
                            src={typeof cover === "string" ? cover : cover?.src}
                            alt={title}
                            width="600"
                            height="400"
                            loading="lazy"
                            decoding="async"
                            class="max-h-[176px] object-contain w-auto"
                        />
                    )
                ) : (
                    <img
                        src="/images/placeholder.svg"
                        alt={title}
                        width="600"
                        height="400"
                        loading="lazy"
                        decoding="async"
                        class="max-h-[176px] object-contain w-auto"
                    />
                )
            }
        </div>

        <div class="p-4">
            <h3
                class="text-base font-semibold text-gray-900 group-hover:underline"
            >
                {title}
            </h3>
            <p class="mt-1 text-sm text-gray-600 line-clamp-2">
                {description ?? "Recurso descargable."}
            </p>

            <div class="mt-3 flex flex-wrap gap-2">
                {
                    category && (
                        <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs text-gray-700">
                            {category}
                        </span>
                    )
                }
                {
                    tags.length > 0 && (
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs text-gray-700">
                            {tags.slice(0, 2).join(" Â· ")}
                        </span>
                    )
                }
            </div>
        </div>
    </a>

    <div class="px-4 pb-4">
        <div class="mt-2 flex items-center gap-2">
            <span class="text-sm text-gray-500">Ver ficha</span>
            {
                pdfUrl &&
                    (isSameOrigin(pdfUrl) ? (
                        <a
                            href={pdfUrl}
                            class="text-sm underline hover:no-underline"
                            data-gtm="file_download"
                            download
                            aria-label={`Descargar PDF: ${title}`}
                        >
                            Descargar PDF
                        </a>
                    ) : (
                        <a
                            href={pdfUrl}
                            class="text-sm underline hover:no-underline"
                            data-gtm="file_download"
                            target="_blank"
                            rel="noopener"
                            aria-label={`Abrir PDF externo: ${title}`}
                        >
                            Descargar PDF
                        </a>
                    ))
            }
        </div>
    </div>
</article>
