---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import CardImprimible from "../../../components/CardImprimible.astro";

export async function getStaticPaths() {
    const entries = await getCollection("imprimibles");
    const levels = Array.from(
        new Set(entries.map((e) => e.data?.level).filter(Boolean)),
    );
    // Importante: NO codificar en params
    return levels.map((l) => ({
        params: { level: l },
        props: { levelValue: l },
    }));
}

const { levelValue } = Astro.props;
const level = levelValue;

const site = (Astro.site ?? "https://imprimibleseduca.com")
    .toString()
    .replace(/\/$/, "");
const pageUrl = new URL(`/imprimibles/nivel/${encodeURIComponent(level)}`, site)
    .href;

// Dataset (excluye borradores y ordena por fecha DESC)
const all = (await getCollection("imprimibles")).filter((e) => !e.data?.draft);
const list = all
    .filter((e) => e.data?.level === level)
    .sort((a, b) => {
        const da = new Date(a.data?.date ?? 0).getTime();
        const db = new Date(b.data?.date ?? 0).getTime();
        return db - da;
    });

// Mapeo para CardImprimible (cover puede ser ImageMetadata)
const items = list.map((e) => ({
    slug: e.slug,
    title: e.data.title,
    description: e.data.description,
    cover: e.data.cover,
    subject: e.data.subject,
    level: e.data.level,
    pdf: e.data.pdf,
}));

const title = `Imprimibles para ${level}`;
const description = `Listado de imprimibles para ${level}. Descarga y utiliza en clase o en casa.`;

// JSON-LD CollectionPage + ItemList
const collectionLd = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description,
    url: pageUrl,
    isPartOf: { "@type": "WebSite", name: "Imprimibles Educativos", url: site },
};

const itemListLd = items.length
    ? {
          "@context": "https://schema.org",
          "@type": "ItemList",
          itemListElement: items.map((it, i) => ({
              "@type": "ListItem",
              position: i + 1,
              url: `${site}/imprimibles/${it.slug}`,
              name: it.title,
          })),
      }
    : null;
---

<BaseLayout
    title={`${title} | Imprimibles Educativos`}
    description={description}
    ogType="website"
>
    <Fragment slot="head">
        <link rel="canonical" href={pageUrl} />
        <meta property="og:url" content={pageUrl} />
        <script
            type="application/ld+json"
            set:html={JSON.stringify(collectionLd)}
        />
        {
            itemListLd && (
                <script
                    type="application/ld+json"
                    set:html={JSON.stringify(itemListLd)}
                />
            )
        }
        {items.length === 0 && <meta name="robots" content="noindex, follow" />}
    </Fragment>

    {/* Breadcrumbs visibles */}
    <nav aria-label="Breadcrumb" class="max-w-6xl mx-auto px-4 pt-6">
        <ol class="flex flex-wrap items-center gap-2 text-sm text-slate-600">
            <li>
                <a href="/imprimibles" class="hover:underline">Imprimibles</a>
            </li>
            <li aria-hidden>›</li>
            <li class="text-slate-900 font-medium">{level}</li>
        </ol>
    </nav>

    <section class="max-w-6xl mx-auto py-8 px-4">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">{title}</h1>
        <p class="text-slate-600 mt-2 max-w-2xl">{description}</p>

        {/* Intro dinámico para SEO */}
        <div class="mt-4 text-slate-700 text-base leading-relaxed">
            <p>
                En esta sección tienes una selección de <strong
                    >imprimibles para {level}</strong
                >. Son fichas diseñadas para adaptarse a este nivel educativo y
                facilitar el aprendizaje.
            </p>
        </div>

        {
            items.length === 0 ? (
                <p class="mt-8 text-slate-600">
                    Aún no hay imprimibles para este nivel.
                </p>
            ) : (
                <>
                    <h2 class="text-xl font-semibold mt-8 mb-4">
                        Recursos disponibles
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {items.map((it, i) => (
                            <CardImprimible
                                slug={it.slug}
                                title={it.title}
                                description={it.description}
                                cover={it.cover}
                                subject={it.subject}
                                level={it.level}
                                pdf={it.pdf}
                                eager={i < 12}
                            />
                        ))}
                    </div>
                </>
            )
        }
    </section>
</BaseLayout>
