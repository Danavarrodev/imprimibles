---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CardImprimible from "../../components/CardImprimible.astro";
import { getCollection } from "astro:content";

const items = await getCollection("imprimibles");
const sorted = items.sort((a,b) => +b.data.date - +a.data.date);
---
<BaseLayout title="Imprimibles | Descarga directa" description="Listado de imprimibles por fecha.">
  <h1 class="text-2xl font-bold mb-6">Imprimibles</h1>

  <div id="filtersInfo" class="mb-4 text-sm text-slate-600 hidden"></div>

  <div id="grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {sorted.map(item => (
      <div data-card data-subject={item.data.subject} data-level={item.data.level}>
        <CardImprimible item={item} />
      </div>
    ))}
  </div>

  <p id="noResults" class="text-slate-500 mt-6 hidden">No hay imprimibles que coincidan con este filtro.</p>

  <script>
    // Filtrado en cliente por query (?subject=...&level=...)
    const params = new URLSearchParams(location.search);
    const s = params.get('subject')?.toLowerCase();
    const l = params.get('level')?.toLowerCase();

    const cards = Array.from(document.querySelectorAll('[data-card]'));
    let visible = 0;

    cards.forEach(card => {
      const cs = card.dataset.subject?.toLowerCase();
      const cl = card.dataset.level?.toLowerCase();
      const ok = (!s || cs === s) && (!l || cl === l);
      card.style.display = ok ? '' : 'none';
      if (ok) visible++;
    });

    // UI de filtros activos
    const info = document.getElementById('filtersInfo');
    if (s || l) {
      info.classList.remove('hidden');
      info.innerHTML = `
        Filtrando por:
        ${s ? `<span class="ml-1 px-2 py-1 bg-slate-100 rounded">${s}</span>` : ''}
        ${l ? `<span class="ml-1 px-2 py-1 bg-slate-100 rounded">${l}</span>` : ''}
        <a class="ml-3 underline" href="/imprimibles/">Quitar filtros</a>
      `;
    }

    // Mensaje sin resultados
    document.getElementById('noResults').classList.toggle('hidden', visible > 0);
  </script>
</BaseLayout>
