---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CardImprimible from "../../components/CardImprimible.astro";
import { getCollection } from "astro:content";

const items = await getCollection("imprimibles");
const sorted = items.sort((a,b) => +b.data.date - +a.data.date);

// Leer parámetros de la URL
const url = new URL(Astro.request.url);
const subjectFilter = url.searchParams.get("subject");
const levelFilter = url.searchParams.get("level");

// Filtrar si hay parámetros
let filtered = sorted;
if (subjectFilter) {
  filtered = filtered.filter(i => i.data.subject.toLowerCase() === subjectFilter.toLowerCase());
}
if (levelFilter) {
  filtered = filtered.filter(i => i.data.level.toLowerCase() === levelFilter.toLowerCase());
}
---
<BaseLayout title="Imprimibles | Descarga directa" description="Listado de imprimibles por fecha.">
  <h1 class="text-2xl font-bold mb-6">Imprimibles</h1>

  <!-- Mostrar filtros activos -->
  {(subjectFilter || levelFilter) && (
    <div class="mb-4 text-sm text-slate-600">
      Filtrando por:
      {subjectFilter && <span class="ml-1 px-2 py-1 bg-slate-100 rounded">{subjectFilter}</span>}
      {levelFilter && <span class="ml-1 px-2 py-1 bg-slate-100 rounded">{levelFilter}</span>}
      <a href="/imprimibles/" class="ml-3 underline">Quitar filtros</a>
    </div>
  )}

  <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {filtered.map(item => <CardImprimible item={item} />)}
  </div>

  {filtered.length === 0 && (
    <p class="text-slate-500 mt-6">No hay imprimibles que coincidan con este filtro.</p>
  )}
</BaseLayout>
