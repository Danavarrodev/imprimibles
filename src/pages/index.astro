---
import BaseLayout from "../layouts/BaseLayout.astro";
import CardImprimible from "../components/CardImprimible.astro";
import CardRecurso from "../components/CardRecurso.astro";
import { getCollection } from "astro:content";

// Contenido
const imprimibles = await getCollection("imprimibles");
const recursos = await getCollection("recursos");
const EAGER_COUNT = 6; // 3 columnas x 2 filas. Pon 3 si quieres solo la 1Âª fila.

// Orden por fecha (tolerante si falta date)
const sortedImprimibles = imprimibles
  .map((it) => ({ ...it, __ts: new Date(it.data?.date || 0).getTime() }))
  .sort((a, b) => b.__ts - a.__ts);

const sortedRecursos = recursos
  .map((it) => ({ ...it, __ts: new Date(it.data?.date || 0).getTime() }))
  .sort((a, b) => b.__ts - a.__ts);

// Mezcla para "Ãšltimos aÃ±adidos" (imprimibles + recursos)
const latestMixed = [
  ...sortedImprimibles.map((x) => ({ type: "imprimible", ...x })),
  ...sortedRecursos.map((x) => ({ type: "recurso", ...x })),
]
  .sort((a, b) => b.__ts - a.__ts)
  .slice(0, EAGER_COUNT);

// Subjects Ãºnicos para chips (para el bloque de â€œExplorar por asignaturaâ€)
const subjects = Array.from(
  new Set(imprimibles.map((i) => i.data.subject).filter(Boolean)),
).sort((a, b) => a.localeCompare(b, "es"));

// --- ICONOS (SVG inline, sin dependencias) ---
const SVG = {
  book: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22.5Z"/></svg>`,
  calc: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M8 6h8M8 10h2m4 0h2M8 14h2m4 0h2M8 18h8"/></svg>`,
  leaf: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 3C7 7 5 10 5 14a7 7 0 0 0 14 0c0-6-4-9-8-11Z"/><path d="M7 14c4 0 6-2 10-6"/></svg>`,
  globe: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a18 18 0 0 1 0 20M12 2a18 18 0 0 0 0 20"/></svg>`,
  palette: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 22a10 10 0 1 1 9.54-13.06 3 3 0 0 1-2.87 4.06h-1.67a2 2 0 0 0-2 2 3 3 0 0 1-3 3Z"/><circle cx="7.5" cy="10.5" r="1"/><circle cx="12" cy="7.5" r="1"/><circle cx="16.5" cy="10.5" r="1"/></svg>`,
  lang: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M5 8h14M7 8s2 7 5 7 5-7 5-7M12 15v4M10 19h4"/></svg>`,
  doc: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M10 13h4M8 17h8"/></svg>`,
} as const;

type SvgKey = keyof typeof SVG;
function subjectIconKey(label: string): SvgKey {
  const k = String(label).toLowerCase();
  if (k === "matemÃ¡ticas" || k === "matematicas") return "calc";
  if (k === "lengua") return "book";
  if (k === "ciencias naturales") return "leaf";
  if (k === "ciencias sociales") return "globe";
  if (k === "inglÃ©s" || k === "ingles") return "lang";
  if (k === "arte") return "palette";
  return "doc";
}

// JSON-LD WebSite + SearchAction (SEO sitelinks)
const site = Astro.site ?? "https://imprimibleseduca.com";
const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  url: site,
  name: "Imprimibles Educativos",
  potentialAction: {
    "@type": "SearchAction",
    // si luego unificas en /materiales, cambia esta URL
    target: `${site}/imprimibles?search={search_term_string}`,
    "query-input": "required name=search_term_string",
  },
};
---

<BaseLayout
  title="Imprimibles y recursos educativos listos para imprimir | Inicio"
  description="Descarga gratis fichas, pÃ³sters, juegos y plantillas en PDF listos para imprimir. Imprimibles y recursos por asignatura, nivel y categorÃ­a."
>
  <Fragment slot="head">
    <script
      type="application/ld+json"
      set:html={JSON.stringify(websiteJsonLd)}
    />
  </Fragment>

  <!-- HERO -->
  <section
    class="mx-auto max-w-7xl px-4 pt-10 pb-8 grid gap-8 md:grid-cols-2 items-center"
  >
    <div class="space-y-5">
      <h1
        class="text-4xl md:text-5xl font-extrabold leading-tight tracking-tight text-slate-900"
      >
        Material educativo <span class="text-indigo-600"
          >listo para imprimir</span
        >
      </h1>
      <p class="text-slate-600 text-lg">
        Fichas, pÃ³sters y juegos para <strong>infantil y primaria</strong>, y
        plantillas Ãºtiles para el dÃ­a a dÃ­a.
      </p>
      <div class="flex flex-wrap gap-3">
        <a href="/imprimibles" class="btn-primary">Ver imprimibles â†’</a>
        <a href="/recursos" class="btn-primary">Ver recursos â†’</a>
      </div>

      <p class="text-sm text-slate-500">
        Gratis Â· Formato A4 Â· Listos para imprimir
      </p>
    </div>

    <!-- Bloque visual placeholder -->
    <div class="rounded-2xl border border-slate-200 bg-white/70 p-6">
      <p class="text-slate-600">
        Sugerencia: collage con 3-4 portadas o una malla de ejemplos.
      </p>
    </div>
  </section>

  <!-- ACCESOS RÃPIDOS A ASIGNATURAS (imprimibles) -->
  {
    subjects.length > 0 && (
      <section class="mx-auto max-w-7xl px-4 pb-2">
        <h2 class="text-xl font-semibold text-slate-900 mb-3">
          Explorar por asignatura
        </h2>
        <nav class="flex flex-wrap gap-2">
          {subjects.map((s) => {
            const maybe = subjectIconKey(s);
            const svg = SVG[maybe] ?? SVG.doc;
            return (
              <a
                href={`/imprimibles/asignatura/${encodeURIComponent(s)}`}
                class="inline-flex items-center gap-2 rounded-full bg-slate-100 text-slate-800 px-4 py-2 text-sm font-medium hover:bg-indigo-100 hover:text-indigo-700 transition"
              >
                <span class="inline-flex text-slate-700" set:html={svg} />
                {s}
              </a>
            );
          })}
        </nav>
      </section>
    )
  }

  <!-- ÃšLTIMOS AÃ‘ADIDOS (mezclado) -->
  <section class="py-12 bg-gradient-to-b from-white to-slate-50">
    <div class="mx-auto max-w-7xl px-4">
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8"
      >
        <div>
          <h2
            class="text-2xl md:text-3xl font-bold tracking-tight text-slate-900"
          >
            Ãšltimos aÃ±adidos
          </h2>
          <p class="mt-1 text-slate-600 text-sm md:text-base">
            Lo mÃ¡s reciente del catÃ¡logo: imprimibles y recursos.
          </p>
        </div>

      </div>

      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {
          latestMixed.map((it, i) =>
            it.type === "imprimible" ? (
              <CardImprimible
                title={it.data.title}
                description={it.data.description}
                cover={it.data.cover}
                subject={it.data.subject}
                level={it.data.level}
                slug={it.slug}
                pdf={it.data.pdf}
                eager={i < EAGER_COUNT}
              />
            ) : (
              <CardRecurso
                title={it.data.title}
                description={it.data.description}
                cover={it.data.cover}
                category={it.data.category}
                tags={it.data.tags}
                slug={it.slug}
                pdf={it.data.pdf}
              />
            ),
          )
        }
      </div>

      {
        latestMixed.length === 0 && (
          <p class="mt-10 rounded-xl border border-dashed p-12 text-center text-slate-600">
            AÃºn no hay contenido publicado. Â¡Vuelve pronto! ðŸ˜Š
          </p>
        )
      }
    </div>
  </section>

  <style is:global>
    .icon {
      width: 16px;
      height: 16px;
      display: block;
    }
  </style>
</BaseLayout>
